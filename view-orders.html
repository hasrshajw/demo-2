<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PayrollPro - All Orders</title>
    <!-- Fonts & Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
    <style>
        /* --- 1. MODERN DESIGN SYSTEM & UI PALETTE --- */
        :root {--font-main: "IBM Plex Sans", ui-sans-serif, system-ui, sans-serif;--font-icon: "Material Symbols Outlined";--light-bg-primary: #ffffff;--light-bg-secondary: #f7f9fc;--light-bg-tertiary: #f1f3f6;--light-text-primary: #012726;--light-text-secondary: #52616b;--light-text-muted: #9ca3af;--light-border: #e5e7eb;--light-border-hover: #d1d5db;--color-primary: #012726;--color-primary-hover: #023d3c;--color-primary-text: #ffffff;--color-accent: #33C375;--color-accent-hover: #2CAC66;--color-accent-text: #012726;--color-danger: #ef4444;--color-danger-hover: #dc2626;--color-danger-text: #ffffff;--color-warning: #f59e0b;--color-warning-hover: #d97706;--color-warning-text: #ffffff;--color-reopen: #6f42c1;--color-reopen-hover: #5a3d9a;--color-reopen-text: #ffffff;--status-pending-bg: #eef2ff;--status-pending-text: #4338ca;--status-completed-bg: #f0fdf4;--status-completed-text: #166534;--status-overdue-bg: #fef2f2;--status-overdue-text: #be123c;--status-overdue-border: #fecaca;--status-upcoming-bg: #fffbeb;--status-upcoming-text: #b45309;--status-upcoming-border: #fde68a;--color-focus-ring: rgba(51, 195, 117, 0.35);--radius-sm: 0.25rem;--radius-md: 0.5rem;--radius-lg: 1rem;--shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.04);--shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.07), 0 2px 4px -2px rgb(0 0 0 / 0.07);--shadow-lg: 0 10px 20px -3px rgb(0 0 0 / 0.07), 0 4px 8px -4px rgb(0 0 0 / 0.07);--ease: cubic-bezier(.4,0,.2,1);}

        /* --- 2. BASE STYLES & ANIMATIONS --- */
        *, *::before, *::after { box-sizing: border-box; }
        html { -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
        body {font-family: var(--font-main);background-color: var(--light-bg-secondary);color: var(--light-text-secondary);margin: 0;min-height: 100vh;padding-top: 70px;}
        .app-container {max-width: 72rem;margin: 2rem auto;padding: 0 1rem;width: 100%;}
        h1, h2, h3 {font-weight: 600;color: var(--light-text-primary);margin: 0;}
        h2 { font-size: 1.5rem; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes fadeUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .screen.active { display: block; animation: fadeUp 0.5s var(--ease) forwards; }
        .text-center { text-align: center; }

        /* --- 3. GLOBAL COMPONENTS (Buttons, Tags, Cards) --- */
        button, .btn { display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; padding: 0.75rem 1.25rem; border-radius: var(--radius-md); font-weight: 600; font-size: 0.875rem; transition: all 0.2s var(--ease); border: 1px solid transparent; cursor: pointer; -webkit-user-select: none; user-select: none; }
        button:hover:not(:disabled), .btn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: var(--shadow-md); }
        .status-tag { display: inline-flex; align-items: center; gap: 0.375rem; padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; }
        .status-tag::before { content: ''; display: block; width: 0.5rem; height: 0.5rem; border-radius: 50%; }
        .status-tag.pending { background-color: var(--status-pending-bg); color: var(--status-pending-text); } .status-tag.pending::before { background-color: var(--status-pending-text); }
        .status-tag.completed { background-color: var(--status-completed-bg); color: var(--status-completed-text); } .status-tag.completed::before { background-color: var(--status-completed-text); }
        .status-tag.overdue { background-color: var(--status-overdue-bg); color: var(--status-overdue-text); } .status-tag.overdue::before { background-color: var(--status-overdue-text); }
        .status-tag.upcoming-due { background-color: var(--status-upcoming-bg); color: var(--status-upcoming-text); } .status-tag.upcoming-due::before { background-color: var(--status-upcoming-text); }
        .card { background-color: var(--light-bg-primary); border: 1px solid var(--light-border); border-radius: var(--radius-lg); padding: 1.5rem; box-shadow: var(--shadow-sm); }
        .input-group { position: relative; }
        .input-field { width: 100%; background-color: var(--light-bg-primary); border: 1px solid var(--light-border); border-radius: var(--radius-md); font-size: 1rem; padding: 1rem; color: var(--light-text-primary); transition: all 0.2s; outline: none; }
        .input-label { position: absolute; top: 1rem; left: 1rem; color: var(--light-text-secondary); pointer-events: none; transition: all 0.2s var(--ease); background-color: var(--light-bg-primary); padding: 0 0.25rem; }
        .input-field:focus + .input-label, .input-field:not(:placeholder-shown) + .input-label { top: -0.625rem; font-size: 0.75rem; color: var(--color-primary); }
        .input-field:focus { border-color: var(--color-primary); }

        /* --- 4. NAVBAR & FAB STYLES --- */
        .navbar { background-color: var(--light-bg-primary); padding: 10px 2rem; box-shadow: var(--shadow-md); display: flex; align-items: center; justify-content: space-between; position: fixed; top: 0; left: 0; right: 0; z-index: 1000; height: 70px; }
        .navbar-logo a { text-decoration: none; color: var(--light-text-primary); font-weight: 700; font-size: 1.5rem; }
        .navbar-profile { position: relative; }
        .navbar-profile .profile-image { height: 45px; width: 45px; border-radius: 50%; object-fit: cover; cursor: pointer; border: 2px solid #e0e0e0; }
        .profile-dropdown { position: absolute; top: calc(100% + 12px); right: 0; background: var(--light-bg-primary); border-radius: var(--radius-md); box-shadow: var(--shadow-md); padding: 8px; min-width: 160px; z-index: 1001; visibility: hidden; opacity: 0; transform: translateY(-10px); transition: all 0.2s ease-out; }
        .profile-dropdown.show { visibility: visible; opacity: 1; transform: translateY(0); }
        .profile-dropdown button { display: flex; align-items: center; gap: 10px; width: 100%; padding: 10px 12px; border: none; background: none; text-align: left; font-size: 15px; color: var(--light-text-primary); border-radius: var(--radius-sm); cursor: pointer; transition: background-color 0.2s ease; }
        .profile-dropdown button:hover { background-color: var(--light-bg-tertiary); }
        .profile-dropdown .icon { font-size: 18px; }
        .fab-container { position: fixed; bottom: 30px; right: 30px; z-index: 999; }
        .fab-button { width: 60px; height: 60px; border-radius: 50%; background: var(--color-primary); color: white; border: none; box-shadow: var(--shadow-lg); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.3s cubic-bezier(0.68, -0.55, 0.27, 1.55); }
        .fab-button .icon { font-size: 32px; font-weight: 300; line-height: 1; }
        .fab-button:hover { background: var(--color-primary-hover); transform: translateY(-2px); }

        /* --- 5. ORDER LIST & SKELETON LOADER --- */
        .order-list-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1.5rem; }
        .order-card { background-color: white; border: 1px solid var(--light-border); border-radius: var(--radius-md); padding: 1.5rem; box-shadow: var(--shadow-sm); transition: all 0.2s var(--ease); cursor: pointer; display: flex; flex-direction: column; gap: 1rem; }
        .order-card:hover { transform: translateY(-4px); box-shadow: var(--shadow-md); border-color: var(--light-border-hover); }
        .order-card-header { display: flex; flex-direction: column; gap: 0.25rem; }
        .order-card-customer { font-size: 1.125rem; font-weight: 600; color: var(--light-text-primary); }
        .order-card-mobile { font-size: 0.875rem; color: var(--light-text-secondary); }
        .order-card-footer { display: flex; justify-content: space-between; align-items: center; margin-top: auto; padding-top: 1rem; border-top: 1px dashed var(--light-border); }
        .order-card-date { font-size: 0.875rem; font-weight: 500; color: var(--light-text-primary); }
        .skeleton-card { background-color: var(--light-bg-primary); border: 1px solid var(--light-border); border-radius: var(--radius-md); padding: 1.5rem; box-shadow: var(--shadow-sm); }
        .skeleton { background-color: var(--light-bg-tertiary); border-radius: var(--radius-sm); animation: pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 50% { opacity: .5; } }
        .skeleton.h-6 { height: 1.5rem; } .skeleton.w-3_4 { width: 75%; } .skeleton.h-4 { height: 1rem; } .skeleton.w-1_2 { width: 50%; } .skeleton.w-1_3 { width: 33.33%; } .skeleton.mt-4 { margin-top: 1rem; } .skeleton.mt-2 { margin-top: 0.5rem; }
        .loading-overlay { position: fixed; inset: 0; width: 100%; height: 100%; background-color: rgba(255, 255, 255, 0.9); z-index: 1001; display: flex; align-items: center; justify-content: center; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .spinner { border: 6px solid var(--light-bg-tertiary); border-top: 6px solid var(--color-primary); border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; }
        
        @media (max-width: 640px) { body { padding-left: 0; padding-right: 0; } .app-container { padding: 0; margin: 1rem auto; } }
    </style>
</head>
<body>

    <nav class="navbar">
        <div class="navbar-logo">
            <a href="#" id="dashboard-link">PayrollPro</a>
        </div>
        <div class="navbar-profile" id="profileContainer">
            <img src="https://i.stack.imgur.com/34AD2.jpg" alt="User Profile" class="profile-image" id="profileImage">
            <div class="profile-dropdown" id="profileDropdown">
                <button id="nav-logout-btn"><span class="icon material-symbols-outlined">logout</span>Logout</button>
            </div>
        </div>
    </nav>
    
    <div class="app-container">
        <div id="view-orders-screen" class="screen active">
            <div class="card" style="margin-bottom: 2rem;">
                <h2 style="margin-bottom: 1.5rem;">Filter Orders</h2>
                <div style="display: grid; grid-template-columns: 1fr; gap: 1rem; @media (min-width: 768px) { grid-template-columns: 1fr 1fr; }">
                    <div class="input-group">
                        <input type="text" id="order-search" class="input-field" placeholder=" ">
                        <label for="order-search" class="input-label">Search by Name, Mobile, or Address</label>
                    </div>
                    <div class="input-group">
                        <select id="order-filter" class="input-field" style="padding-top: 1rem; padding-bottom: 1rem;">
                            <option value="all">All Statuses</option>
                            <option value="pending">Pending</option>
                            <option value="completed">Completed</option>
                            <option value="overdue">Overdue</option>
                            <option value="upcoming-due">Upcoming Due (3 days)</option>
                        </select>
                    </div>
                </div>
            </div>
            <div id="order-list-container" class="order-list-container">
                <!-- Skeleton loaders or order cards will be injected here -->
            </div>
            <div id="order-list-empty" class="text-center" style="display: none; padding: 3rem;">
                <span class="material-symbols-outlined" style="font-size: 3rem; color: var(--light-text-muted);">folder_off</span>
                <p style="margin-top: 1rem; color: var(--light-text-secondary);">No orders found matching your criteria.</p>
            </div>
        </div>
    </div>

    <div class="fab-container" id="fabContainer">
        <button class="fab-button" id="fabButton" onclick="window.location.href='order-form.html'">
            <span class="icon material-symbols-outlined">add</span>
        </button>
    </div>

    <div id="loading-overlay" class="loading-overlay" style="display: none;"><div class="spinner"></div></div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, onSnapshot, collection, query, orderBy, getDoc, doc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- DOM ELEMENTS & APP STATE ---
        const loadingOverlay = document.getElementById('loading-overlay');
        const profileImage = document.getElementById('profileImage');
        const profileDropdown = document.getElementById('profileDropdown');
        const navLogoutBtn = document.getElementById('nav-logout-btn');
        const dashboardLink = document.getElementById('dashboard-link');
        const orderListContainer = document.getElementById('order-list-container');
        const orderListEmpty = document.getElementById('order-list-empty');
        const orderSearchInput = document.getElementById('order-search');
        const orderFilterSelect = document.getElementById('order-filter');
        let auth, db, orders = [];

        // --- UI & HELPER FUNCTIONS ---
        const showLoading = () => loadingOverlay.style.display = 'flex';
        const hideLoading = () => loadingOverlay.style.display = 'none';
        function toggleProfileMenu() { profileDropdown.classList.toggle('show'); }
        const createSkeletonCard = () => `<div class="skeleton-card"><div class="skeleton h-6 w-3_4"></div><div class="skeleton h-4 w-1_2 mt-2"></div><div class="skeleton h-4 w-1_3 mt-4"></div></div>`;
        const showSkeletonLoaders = (count = 6) => { orderListContainer.innerHTML = Array(count).fill(createSkeletonCard()).join(''); orderListContainer.style.display = 'grid'; orderListEmpty.style.display = 'none'; };

        // --- DATA & RENDERING FUNCTIONS ---
        const getStatusInfo = (order, today) => {
            if (order.status === 'completed') { return { text: 'Completed', className: 'completed' }; }
            const dueDate = order.dueDate ? new Date(order.dueDate + 'T00:00:00') : null;
            if (dueDate && dueDate < today) { return { text: 'Overdue', className: 'overdue' }; }
            if (dueDate) {
                const daysDiff = Math.ceil((dueDate.getTime() - today.getTime()) / (1000 * 3600 * 24));
                if (daysDiff >= 0 && daysDiff <= 3) { return { text: `Due in ${daysDiff} day${daysDiff !== 1 ? 's' : ''}`, className: 'upcoming-due' }; }
            }
            return { text: 'Pending', className: 'pending' };
        };
        
        const renderOrderList = () => {
            const searchQuery = orderSearchInput.value.toLowerCase();
            const filterStatus = orderFilterSelect.value;
            const today = new Date(); today.setHours(0, 0, 0, 0);

            const filteredOrders = orders.filter(order => {
                const matchesSearch = order.name.toLowerCase().includes(searchQuery) || order.address.toLowerCase().includes(searchQuery) || (order.mobileNumber && order.mobileNumber.includes(searchQuery));
                if (filterStatus === 'all') { return matchesSearch; }
                const statusInfo = getStatusInfo(order, today);
                return matchesSearch && statusInfo.className === filterStatus;
            });
            
            if (filteredOrders.length === 0) { orderListEmpty.style.display = 'block'; orderListContainer.style.display = 'none'; return; }
            orderListEmpty.style.display = 'none'; orderListContainer.style.display = 'grid'; 
            orderListContainer.innerHTML = ''; 

            filteredOrders
                .sort((a, b) => { // Sort by status priority then due date
                    const statusOrder = { 'overdue': 1, 'upcoming-due': 2, 'pending': 3, 'completed': 4 };
                    const statusA = getStatusInfo(a, today).className;
                    const statusB = getStatusInfo(b, today).className;
                    if (statusOrder[statusA] !== statusOrder[statusB]) { return statusOrder[statusA] - statusOrder[statusB]; }
                    return (new Date(a.dueDate)?.getTime() || 0) - (new Date(b.dueDate)?.getTime() || 0);
                })
                .forEach(order => {
                    const card = document.createElement('div');
                    card.className = 'order-card';
                    const statusInfo = getStatusInfo(order, today);
                    card.innerHTML = `<div class="order-card-header"><span class="order-card-customer">${order.name}</span><span class="order-card-mobile">${order.mobileNumber || 'No mobile'}</span></div><div class="status-tag ${statusInfo.className}">${statusInfo.text}</div><div class="order-card-footer"><span class="order-card-date">Due: ${order.dueDate || 'Not set'}</span><span class="material-symbols-outlined" style="color: var(--light-text-muted);">arrow_forward_ios</span></div>`;
                    // This link assumes you will create an 'order-details.html' page
                    card.addEventListener('click', () => window.location.href = `order-details.html?id=${order.id}`); 
                    orderListContainer.appendChild(card);
                });
        };

        // --- FIREBASE & CORE LOGIC ---
        async function initializeFirebase() {
            try {
                const firebaseConfig = {
                    apiKey: "AIzaSyBQonPZMTX0m_yZF-MOyBuKU8nwQdVVdRg",
                    authDomain: "payment-form-b77e2.firebaseapp.com",
                    projectId: "payment-form-b77e2",
                    storageBucket: "payment-form-b77e2.firebasestorage.app",
                    messagingSenderId: "796020240904",
                    appId: "1:796020240904:web:fba6b6f0e1b743dd8017bd",
                    measurementId: "G-DHJJ4WNYR4"
                };
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        const userDoc = await getDoc(doc(db, "users", user.uid));
                        if (!userDoc.exists() || userDoc.data().status !== 'approved') {
                            window.location.href = 'login.html';
                            return;
                        }
                        const userProfile = userDoc.data();
                        profileImage.src = user.photoURL || 'https://i.stack.imgur.com/34AD2.jpg';
                        dashboardLink.href = userProfile.role === 'admin' ? 'admin-dashboard.html' : 'employee-dashboard.html';
                        listenForOrders();
                    } else {
                        window.location.href = 'login.html';
                    }
                });
            } catch (error) { console.error("Firebase Init Error:", error); hideLoading(); }
        }
        
        async function handleSignOut() { showLoading(); try { await signOut(auth); } catch (error) { hideLoading(); } }
        
        function listenForOrders() {
            showSkeletonLoaders();
            const q = query(collection(db, `upvc_orders`), orderBy('createdAt', 'desc'));
            onSnapshot(q, (snapshot) => {
                orders = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderOrderList();
                hideLoading();
            }, (error) => { console.error("Firestore Snapshot Error:", error); hideLoading(); });
        }

        // --- EVENT LISTENERS ---
        navLogoutBtn.addEventListener('click', handleSignOut);
        orderSearchInput.addEventListener('input', renderOrderList);
        orderFilterSelect.addEventListener('change', renderOrderList);
        profileImage.addEventListener('click', (e) => { e.stopPropagation(); toggleProfileMenu(); });
        window.addEventListener('click', () => { if (profileDropdown.classList.contains('show')) { toggleProfileMenu(); } });

        // --- INITIALIZATION ---
        initializeFirebase();
    </script>
</body>
</html>
