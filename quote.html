<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PayrollPro - Quote</title>
    <!-- Fonts & Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
    <style>
        /* --- EXACT, COMPLETE CSS FROM YOUR EXAMPLE --- */
        :root{--font-main:"IBM Plex Sans",ui-sans-serif,system-ui,sans-serif;--font-icon:"Material Symbols Outlined";--light-bg-primary:#fff;--light-bg-secondary:#f7f9fc;--light-bg-tertiary:#f1f3f6;--light-text-primary:#012726;--light-text-secondary:#52616b;--light-text-muted:#9ca3af;--light-border:#e5e7eb;--light-border-hover:#d1d5db;--color-primary:#012726;--color-primary-hover:#023d3c;--color-primary-text:#fff;--color-accent:#33c375;--color-accent-hover:#2cac66;--color-accent-text:#012726;--color-danger:#ef4444;--color-danger-hover:#dc2626;--color-danger-text:#fff;--color-warning:#f59e0b;--color-warning-hover:#d97706;--color-warning-text:#fff;--color-reopen:#6f42c1;--color-reopen-hover:#5a3d9a;--color-reopen-text:#fff;--status-pending-bg:#eef2ff;--status-pending-text:#4338ca;--status-completed-bg:#f0fdf4;--status-completed-text:#166534;--status-overdue-bg:#fef2f2;--status-overdue-text:#be123c;--status-overdue-border:#fecaca;--status-upcoming-bg:#fffbeb;--status-upcoming-text:#b45309;--status-upcoming-border:#fde68a;--color-focus-ring:rgba(51,195,117,.35);--radius-sm:0.25rem;--radius-md:0.5rem;--radius-lg:1rem;--shadow-sm:0 1px 2px 0 rgba(0,0,0,.04);--shadow-md:0 4px 6px -1px rgba(0,0,0,.07),0 2px 4px -2px rgba(0,0,0,.07);--shadow-lg:0 10px 20px -3px rgba(0,0,0,.07),0 4px 8px -4px rgba(0,0,0,.07);--ease:cubic-bezier(.4,0,.2,1)}*,:after,:before{box-sizing:border-box}html{-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}body{font-family:var(--font-main);background-color:var(--light-bg-secondary);color:var(--light-text-secondary);margin:0;min-height:100vh;display:flex;align-items:flex-start;justify-content:center;padding:1rem;padding-top:1rem}h1,h2,h3{font-weight:600;color:var(--light-text-primary);margin:0}h1{font-size:1.875rem;line-height:2.25rem}h2{font-size:1.5rem;line-height:2rem}h3{font-size:1.25rem;line-height:1.75rem}@keyframes fadeIn{from{opacity:0}to{opacity:1}}@keyframes popIn{0%{opacity:0;transform:scale(.9)}100%{opacity:1;transform:scale(1)}}.screen{display:none}.screen.active{display:block;animation:fadeIn .5s var(--ease) forwards}button,.btn{display:inline-flex;align-items:center;justify-content:center;gap:.5rem;padding:.75rem 1.25rem;border-radius:var(--radius-md);font-weight:600;font-size:.875rem;transition:all .2s var(--ease);border:1px solid transparent;cursor:pointer;-webkit-user-select:none;user-select:none}button:hover:not(:disabled),.btn:hover:not(:disabled){transform:translateY(-2px);box-shadow:var(--shadow-md)}button:focus-visible,.btn:focus-visible{outline:2px solid var(--color-focus-ring);outline-offset:2px}.btn-primary{background-color:var(--color-primary);color:var(--color-primary-text)}.btn-primary:hover:not(:disabled){background-color:var(--color-primary-hover)}.btn-secondary{background-color:var(--light-bg-primary);color:var(--light-text-secondary);border-color:var(--light-border);box-shadow:var(--shadow-sm)}.btn-secondary:hover:not(:disabled){background-color:var(--light-bg-tertiary);border-color:var(--light-border-hover);color:var(--light-text-primary)}.input-group{position:relative}.input-field{width:100%;background-color:var(--light-bg-primary);border:1px solid var(--light-border);border-radius:var(--radius-md);font-size:1rem;padding:1rem;color:var(--light-text-primary);transition:all .2s;outline:none}.input-label{position:absolute;top:1rem;left:1rem;color:var(--light-text-secondary);pointer-events:none;transition:all .2s var(--ease);background-color:var(--light-bg-primary);padding:0 .25rem}
        .input-field:focus + .input-label, .input-field:not(:placeholder-shown) + .input-label {top: -0.625rem; font-size: 0.75rem; color: var(--color-primary);}
        .input-field:focus{border-color:var(--color-primary);box-shadow:0 0 0 3px var(--color-focus-ring)}.modal{display:none;position:fixed;z-index:1000;inset:0;width:100%;height:100%;background-color:rgba(17,24,39,.6);-webkit-backdrop-filter:blur(4px);backdrop-filter:blur(4px);align-items:center;justify-content:center;animation:fadeIn .3s var(--ease)}.modal-content{background-color:#fff;padding:2rem;border-radius:var(--radius-lg);box-shadow:var(--shadow-lg);width:90%;max-width:420px;text-align:center;animation:popIn .3s var(--ease)}.modal-message{font-size:1.125rem;font-weight:500;margin-bottom:1.5rem;color:var(--light-text-primary)}.modal-buttons{display:flex;justify-content:center;gap:1rem}.loading-overlay{position:fixed;inset:0;width:100%;height:100%;background-color:rgba(255,255,255,.9);z-index:1001;display:flex;align-items:center;justify-content:center}.spinner{border:6px solid var(--light-bg-tertiary);border-top:6px solid var(--color-primary);border-radius:50%;width:50px;height:50px;animation:spin 1s linear infinite}@keyframes spin{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}#quote-screen{background:#e9e9e9;padding:20px;font-size:14px}#quote-screen .quote-controls{display:flex;justify-content:center;align-items:center;gap:1rem;margin-bottom:20px}#quote-screen .btn{width:auto}#quote-screen .invoice-box{max-width:794px;margin:auto;background:#fff;border-radius:6px;color:#2d3748;display:flex;flex-direction:column;padding:30px}#quote-screen .header{display:flex;justify-content:space-between;align-items:flex-start;border-bottom:2px solid #e2e8f0;padding-bottom:20px}#quote-screen .logo-img{max-width:160px;height:auto}#quote-screen .invoice-details{text-align:right;font-size:13px;line-height:1.5;color:#718096}#quote-screen .invoice-details strong{color:#2d3748}#quote-screen .bill-to{margin-top:25px}#quote-screen .bill-to h3{font-weight:600;font-size:16px;margin-bottom:8px}#quote-screen .bill-to p{font-size:13px;color:#718096;margin:3px 0;line-height:1.6}#quote-screen table{width:100%;margin-top:25px;border-collapse:collapse;font-size:13px}#quote-screen table th{background-color:#535456;color:#fff;font-weight:600;padding:12px 8px;text-align:left;border-bottom:none}#quote-screen table td{padding:10px 8px;border-bottom:1px solid #e2e8f0;color:#718096}#quote-screen table td:nth-child(2){color:#2d3748;font-weight:500}#quote-screen tbody tr:nth-child(even){background-color:#f8f8f7}#quote-screen tbody tr:nth-child(odd){background-color:#fff}#quote-screen table td:not(:first-child):not(:nth-child(2)),#quote-screen table th:not(:first-child):not(:nth-child(2)){text-align:right}#quote-screen .invoice-summary{margin-top:auto;padding-top:20px;display:flex;justify-content:flex-end}#quote-screen .invoice-summary table{width:40%;font-size:14px;margin-top:0}#quote-screen .invoice-summary table td{border-bottom:1px solid #e2e8f0;padding:8px;background-color:#fff!important}#quote-screen .invoice-summary table tr:last-child{font-weight:700;font-size:18px;color:#2d3748}#quote-screen .invoice-summary table tr:last-child td{background-color:#f7fafc!important;border-bottom:none;padding:12px 8px}#quote-screen .terms{margin-top:20px;padding-top:20px;border-top:1px solid #e2e8f0;font-size:11px;color:#888;line-height:1.5}#quote-screen .terms strong{color:#718096;font-weight:600;font-size:12px}#quote-screen .terms ol{padding-left:15px;margin-top:8px}#quote-screen .terms ol li{margin-bottom:8px}#quote-screen .footer{margin-top:auto;padding-top:20px;border-top:1px solid #e2e8f0;display:flex;justify-content:space-between;align-items:center;font-size:12px;color:#718096}#quote-screen .signature p{margin-top:0;font-weight:600;color:#2d3748}@media (max-width:640px){#quote-screen{padding:0;background-color:#fff}#quote-screen .quote-controls{margin:15px}#quote-screen .invoice-box{padding:15px;min-height:unset;border-radius:0;box-shadow:none}#quote-screen .header{padding-bottom:10px}#quote-screen .logo-img{max-width:100px}#quote-screen .bill-to h3,#quote-screen .invoice-details,#quote-screen .invoice-summary table tr:last-child,#quote-screen table{font-size:10px}#quote-screen .bill-to h3{font-size:12px}#quote-screen table td,#quote-screen table th{padding:5px 4px}#quote-screen .invoice-summary{margin-top:15px;padding-top:15px}#quote-screen .invoice-summary table{width:80%}#quote-screen .invoice-summary table tr:last-child{font-size:12px}#quote-screen .terms{font-size:8px;margin-top:15px;padding-top:15px}#quote-screen .terms li,#quote-screen .terms strong{font-size:8px}#quote-screen .terms ol li{margin-bottom:4px}#quote-screen .footer{font-size:8px;flex-direction:column;align-items:flex-start;gap:8px;margin-top:15px;padding-top:15px}}@media print{@page{size:A4;margin:0}body{background:#fff!important;padding:0!important;margin:0!important}body>*:not(.app-container),.navbar,.fab-container{display:none!important}.app-container{margin:0!important;padding:0!important;max-width:100%!important;width:100%!important}.app-container>*:not(#quote-screen){display:none!important}#quote-screen{display:block!important;padding:0!important;background:#fff!important}#quote-screen .quote-controls{display:none!important}#quote-screen .invoice-box{box-shadow:none!important;border:none!important;border-radius:0!important;margin:0!important;padding:10mm!important;max-width:100%!important;width:100%!important;min-height:initial!important}#quote-screen table th{background-color:#535456!important;color:#fff!important;-webkit-print-color-adjust:exact;print-color-adjust:exact}#quote-screen tbody tr:nth-child(even){background-color:#f8f8f7!important;-webkit-print-color-adjust:exact;print-color-adjust:exact}}
    </style>
</head>
<body>

    <div class="app-container">
        <div id="quote-screen" class="screen active">
            <div id="quote-screen-printable">
                <!-- Content will be injected by JavaScript -->
            </div>
        </div>
    </div>
    
    <div id="price-modal" class="modal">
        <div class="modal-content" style="max-width: 480px; text-align: left;">
             <form id="price-form">
                <h3 style="margin-bottom: 2rem;">Enter Pricing Details</h3>
                <div class="input-group" style="margin-bottom: 1.5rem;">
                    <input type="number" id="price-per-sft" class="input-field" min="0" step="0.01" placeholder=" " required>
                    <label for="price-per-sft" class="input-label">Price per SFT (₹)</label>
                </div>
                <div class="input-group">
                    <input type="number" id="transport-charges" class="input-field" min="0" step="1" placeholder=" " value="0" required>
                    <label for="transport-charges" class="input-label">Transport Charges (₹)</label>
                </div>
                <div class="modal-buttons" style="margin-top: 2rem; justify-content: flex-end;">
                    <button type="button" id="price-cancel-btn" class="btn-secondary">Cancel</button>
                    <button type="submit" class="btn-primary">Generate Quote</button>
                </div>
            </form>
        </div>
    </div>
    <div id="message-modal" class="modal"><div class="modal-content"><p id="message-text" class="modal-message"></p><button id="message-ok-btn" class="btn-primary" style="min-width: 120px;">OK</button></div></div>
    <div id="loading-overlay" class="loading-overlay" style="display: none;"><div class="spinner"></div></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- DOM ELEMENTS & APP STATE ---
        const loadingOverlay = document.getElementById('loading-overlay');
        const messageModal = document.getElementById('message-modal');
        const messageText = document.getElementById('message-text');
        const messageOkBtn = document.getElementById('message-ok-btn');
        const priceModal = document.getElementById('price-modal');
        const priceForm = document.getElementById('price-form');
        const pricePerSftInput = document.getElementById('price-per-sft');
        const transportChargesInput = document.getElementById('transport-charges');
        const priceCancelBtn = document.getElementById('price-cancel-btn');
        const quoteScreenPrintable = document.getElementById('quote-screen-printable');
        let db, auth;

        // --- UI & HELPER FUNCTIONS ---
        const showLoading = () => loadingOverlay.style.display = 'flex';
        const hideLoading = () => loadingOverlay.style.display = 'none';
        const showMessageModal = (message) => { messageText.textContent = message; messageModal.style.display = 'flex'; };

        // --- CORE FUNCTIONALITY ---
        const createQuoteHtml = (order, pricePerSft, transportCharges) => {
            let windowsForPdf = [];
            try { windowsForPdf = JSON.parse(order.windows || '[]'); } catch(e) { console.error("Could not parse window data:", e); }
            
            let tableRows = '';
            let subTotal = 0;

            windowsForPdf.forEach((win, index) => {
                const heightMm = parseFloat(win.height || 0);
                const widthMm = parseFloat(win.width || 0);
                const sft = (widthMm / 304.8) * (heightMm / 304.8);
                const windowCost = sft * pricePerSft;
                subTotal += windowCost;
                const itemName = win.itemType ? (win.itemType.charAt(0).toUpperCase() + win.itemType.slice(1)) : 'Item';
                tableRows += `<tr><td>${(index + 1).toString().padStart(2, '0')}</td><td>${itemName}${win.hasGlass && win.glassName ? ` <br><small>(${win.glassName})</small>` : ''}</td><td>${widthMm}</td><td>${heightMm}</td><td>304.8</td><td>${sft.toFixed(2)}</td><td>${pricePerSft.toLocaleString('en-IN')}</td><td>${windowCost.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td></tr>`;
            });

            const gst = subTotal * 0.18;
            const grandTotal = subTotal + gst + transportCharges;
            const orderId = priceForm.dataset.id;
            
            return `
                <div class="quote-controls">
                    <button id="quote-back-btn" class="btn btn-secondary" data-order-id="${orderId}"><span class="material-symbols-outlined">arrow_back</span>Back to Details</button>
                    <button onclick="window.print()" class="btn btn-primary print-button"><span class="material-symbols-outlined">print</span>Print / Save PDF</button>
                </div>
                <div class="invoice-box">
                    <div>
                        <div class="header">
                            <div class="logo"><p style="font-size: 1.5rem; font-weight: 700; color: var(--color-primary);">PayrollPro</p></div>
                            <div class="invoice-details">
                                <div><strong>Quotation Date:</strong> ${new Date().toLocaleDateString()}</div>
                                <div><strong>Prepared by:</strong> ${order.createdBy || 'N/A'}</div>
                            </div>
                        </div>
                        <div class="bill-to">
                            <h3>QUOTATION FOR</h3>
                            <p><strong>${order.name}</strong><br>${order.address.replace(/\n/g, '<br>')}<br>Phone: ${order.mobileNumber || 'N/A'}</p>
                        </div>
                        <table>
                            <thead><tr><th>S.No</th><th>Item Name</th><th>Width (mm)</th><th>Height (mm)</th><th>mm/ft</th><th>SFT</th><th>Price (₹)</th><th>Total Cost (₹)</th></tr></thead>
                            <tbody>${tableRows}</tbody>
                        </table>
                    </div>
                    <div class="invoice-summary">
                        <table>
                            <tr><td>Sub Total:</td><td style="text-align: right;">${subTotal.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td></tr>
                            <tr><td>GST 18%:</td><td style="text-align: right;">+${gst.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td></tr>
                            <tr><td>Transport:</td><td style="text-align: right;">+${transportCharges.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td></tr>
                            <tr><td>Grand Total:</td><td style="text-align: right;">₹ ${grandTotal.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td></tr>
                        </table>
                    </div>
                    <div class="terms">
                        <strong>Terms & Conditions</strong>
                        <ol>
                            <li>This quotation is based on the <strong>approximate measurements</strong>. Final measurements will be taken after order confirmation. Total square footage (SFT) may vary accordingly.</li>
                            <li>A <strong>signed work order</strong> on official letterhead is required with the <strong>advance payment</strong>.</li>
                            <li><strong>Payment terms:</strong> <strong>60% advance</strong>, <strong>30% after material delivery</strong>, and remaining <strong>10% after installation</strong>.</li>
                            <li>This quotation is <strong>valid for 30 days</strong>.</li>
                            <li><strong>Delivery timeline:</strong> <strong>30 days from the date of final measurement</strong>.</li>
                        </ol>
                    </div>
                    <div class="footer">
                        <div class="icons"><span>📞 Your Phone</span> | <span>✉️ your.email@example.com</span></div>
                        <div class="signature"><p>Authorized Signatory</p></div>
                    </div>
                </div>`;
        };
        
        // --- FIREBASE & PAGE LOGIC ---
        async function initializeFirebase() {
            try {
                const firebaseConfig = {
                    apiKey: "AIzaSyBQonPZMTX0m_yZF-MOyBuKU8nwQdVVdRg",
                    authDomain: "payment-form-b77e2.firebaseapp.com",
                    projectId: "payment-form-b77e2",
                    storageBucket: "payment-form-b77e2.firebasestorage.app",
                    messagingSenderId: "796020240904",
                    appId: "1:796020240904:web:fba6b6f0e1b743dd8017bd",
                    measurementId: "G-DHJJ4WNYR4"
                };
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        const userDoc = await getDoc(doc(db, "users", user.uid));
                        if (!userDoc.exists() || userDoc.data().status !== 'approved') {
                            window.location.href = 'login.html';
                            return;
                        }
                        startPageLogic();
                    } else {
                        window.location.href = 'login.html';
                    }
                });
            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                showMessageModal("Critical error initializing application.");
                hideLoading();
            }
        }
        
        function startPageLogic() {
            const urlParams = new URLSearchParams(window.location.search);
            const orderId = urlParams.get('id');
            if (orderId) {
                priceForm.dataset.id = orderId;
                priceModal.style.display = 'flex'; 
                pricePerSftInput.focus();
            } else {
                showMessageModal("No order specified for quote. Redirecting...");
                setTimeout(() => window.location.href = 'view-orders.html', 2000);
            }
            hideLoading();
        }

        // --- EVENT LISTENERS ---
        priceForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            showLoading();
            const orderId = e.currentTarget.dataset.id;
            const price = parseFloat(pricePerSftInput.value);
            const transport = parseFloat(transportChargesInput.value || 0);

            try {
                const orderRef = doc(db, 'upvc_orders', orderId);
                const orderSnap = await getDoc(orderRef);

                if (orderSnap.exists()) {
                    const order = { id: orderSnap.id, ...orderSnap.data() };
                    quoteScreenPrintable.innerHTML = createQuoteHtml(order, price, transport);
                    priceModal.style.display = 'none';
                    document.getElementById('quote-back-btn').addEventListener('click', (e) => {
                        window.location.href = `order-details.html?id=${e.currentTarget.dataset.id}`;
                    });
                } else {
                    showMessageModal("Could not find the order to generate a quote.");
                }
            } catch (error) {
                console.error("Error generating quote:", error);
                showMessageModal("An error occurred while generating the quote.");
            } finally {
                hideLoading();
            }
        });

        priceCancelBtn.addEventListener('click', () => {
            const orderId = priceForm.dataset.id;
            window.location.href = `order-details.html?id=${orderId}`;
        });
        messageOkBtn.addEventListener('click', () => messageModal.style.display = 'none');

        // --- INITIALIZATION ---
        showLoading();
        initializeFirebase();
    })();
    </script>
</body>
</html>
